<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Song Shop</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header class="nav">
    <img src="/media/logo.jpg" alt="Logo" width="50" height="70">
    <div class="brand">üéµ Song Shop</div>
    <nav>
      <a href="/">Home</a>
      <a href="/genre/pop">Pop</a>
      <a href="/genre/rock">Rock</a>
      <a href="/genre/hip-hop">Hip-Hop</a>
      <a href="/genre/indie">Indie</a>
      <a href="/genre/rnb">R&B</a>
      <a href="/genre/classical">Classical</a>
      <!-- Link to dedicated login page -->
      <a href="/login-page">Profile</a>
      <a id="admin-link" href="/admin" class="admin-link-hidden">Admin</a>
    </nav>
  </header>

  <section class="hero">
    <div class="hero-content">
      <h1>Discover Your Next Favorite Song</h1>
      <p>Explore music from 2020-2025 across multiple genres.</p>
      <a href="/login-page" class="cta-button">Get Started</a>
    </div>
  </section>

  <section class="features">
    <div class="feature-card">
      <h3>Fresh Music Daily</h3>
      <p>New songs from 2020-2025 every time you refresh. Stay with the latest releases.</p>
    </div>
    <div class="feature-card">
      <h3>Multiple Genres</h3>
      <p>Pop, Rock, Hip-Hop, Indie, R&B, and Classical‚Äîall organized and ready to explore.</p>
    </div>
    <div class="feature-card">
      <h3>Direct Spotify Access</h3>
      <p>Click any song to open it instantly in Spotify. Seamless listening experience.</p>
    </div>
  </section>

      <section class="container">
        <h2>Community Message Board</h2>
        <div id="message-board" class="message-board">
          <div id="message-form-container" style="display:none;">
            <div class="message-form">
              <textarea id="messageInput" placeholder="Share your thoughts about music..." maxlength="500"></textarea>
              <div class="form-footer">
                <span id="charCount">0/500</span>
                <button onclick="postMessage()" class="btn">Post Message</button>
              </div>
            </div>
          </div>
          
          <div class="login-prompt" id="login-prompt">
            <p>Please <a href="/login-page">login with Spotify</a> to post messages.</p>
          </div>

          <div id="messages-container" class="messages-container">
            <div class="status-message">Loading messages...</div>
          </div>
        </div>
      </section>
  <script>
    // Check if access token is in URL (from OAuth callback)
    const urlParams = new URLSearchParams(window.location.search);
    const accessToken = urlParams.get('access_token');
    if (accessToken) {
      // Store token in localStorage
      localStorage.setItem('spotify_access_token', accessToken);
      // Clean up URL (remove token from address bar)
      window.history.replaceState({}, document.title, '/');
    }
  </script>
  <script src="/script.js"></script>
  <script src="/spotify-auth.js"></script>
  <script>window.ADMIN_SPOTIFY_ID = "<%= process.env.ADMIN_SPOTIFY_ID || '' %>";</script>
  <script>
    // Initialize user data on page load
    async function initializeMessageBoard() {
      // Check if user is logged in
      if (isLoggedIn()) {
        // If we have access token but no user ID, fetch it
        if (!localStorage.getItem('spotify_user_id')) {
          await getUserSpotifyId();
        }
        document.getElementById('message-form-container').style.display = 'block';
        document.getElementById('login-prompt').style.display = 'none';
      } else {
        document.getElementById('message-form-container').style.display = 'none';
        document.getElementById('login-prompt').style.display = 'block';
      }
      
      // Load message board on home page
      if (document.getElementById('messages-container')) {
        loadMessageBoard();
      }
    }

    // Initialize when page loads
    window.addEventListener('load', initializeMessageBoard);
    function loadMessageBoard() {
      fetch('/api/messages')
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('messages-container');
          const messages = data.messages || [];

          if (messages.length === 0) {
            container.innerHTML = '<div class="no-messages">No messages yet. Be the first to share!</div>';
            return;
          }

          container.innerHTML = messages.map(msg => {
            const isOwner = isLoggedIn() && msg.spotifyId === localStorage.getItem('spotify_user_id');
            const actionsHtml = isOwner ? `
              <div class="message-actions">
                <button data-message-id="${msg.messageId}" class="edit-btn">‚úèÔ∏è Edit</button>
                <button data-message-id="${msg.messageId}" class="delete-btn">Delete</button>
              </div>
            ` : '';
            
            return `
            <div class="message-item">
              <div class="message-header">
                <div class="user-info">
                  ${msg.profilePicUrl ? `<img src="${msg.profilePicUrl}" alt="${msg.userName}" class="user-avatar">` : '<div class="user-avatar-placeholder">üë§</div>'}
                  <div>
                    <strong>${msg.userName}</strong>
                    <span class="message-time">${new Date(msg.createdAt).toLocaleString()}</span>
                    ${msg.updatedAt !== msg.createdAt ? '<span class="edited-badge">(edited)</span>' : ''}
                  </div>
                </div>
                ${actionsHtml}
              </div>
              <div class="message-text">${msg.messageText}</div>
            </div>
            `;
          }).join('');
          
          // Add event listeners to edit and delete buttons
          document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const messageId = this.getAttribute('data-message-id');
              editMessage(messageId);
            });
          });
          
          document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const messageId = this.getAttribute('data-message-id');
              deleteMessage(messageId);
            });
          });
        })
        .catch(err => {
          console.error('Error loading messages:', err);
          document.getElementById('messages-container').innerHTML = '<div class="error-message">Failed to load messages.</div>';
        });
    }

    function postMessage() {
      const text = document.getElementById('messageInput').value.trim();
      if (!text) {
        alert('Please enter a message');
        return;
      }

      const spotifyId = localStorage.getItem('spotify_user_id');
      if (!spotifyId) {
        alert('Please login first');
        return;
      }

      fetch('/api/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spotifyId, messageText: text })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById('messageInput').value = '';
          document.getElementById('charCount').textContent = '0/500';
          loadMessageBoard();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(err => {
        console.error('Error posting message:', err);
        alert('Failed to post message');
      });
    }

    function editMessage(messageId) {
      // Get the message text from the DOM
      const messageElement = event.target.closest('.message-item');
      const currentText = messageElement.querySelector('.message-text').textContent;
      
      const newText = prompt('Edit your message:', currentText);
      if (newText === null) return;

      const spotifyId = localStorage.getItem('spotify_user_id');
      fetch(`/api/messages/${messageId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spotifyId, messageText: newText })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          loadMessageBoard();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(err => {
        console.error('Error editing message:', err);
        alert('Failed to edit message');
      });
    }

    function deleteMessage(messageId) {
      if (!confirm('Delete this message?')) return;

      const spotifyId = localStorage.getItem('spotify_user_id');
      fetch(`/api/messages/${messageId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spotifyId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          loadMessageBoard();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(err => {
        console.error('Error deleting message:', err);
        alert('Failed to delete message');
      });
    }

    // Update character count
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
      messageInput.addEventListener('input', function() {
        document.getElementById('charCount').textContent = this.value.length + '/500';
      });
    }
  </script>
</body>
</html>